#!/usr/bin/env python3

"""
Adds the system certficiate bundle, plus Looks for a
semicolon-delimited list of URLs in PUNCHKICKER_TRUST_CA_URLS, or failing
that in the tag punchkicker-trust-ca-urls, and adds them too.
"""

import os
from punchkicker import env
from urllib.parse import urlparse
from posixpath import basename
from time import ctime

certconf = "/etc/ca-certificates.conf"
certdir = "/usr/share/ca-certificates"
localdir = "local"
localpath = os.path.join(certdir, "local")

env.apk_add("ca-certificates")

extra_ca_urls = env.get("PUNCHKICKER_TRUST_CA_URLS")
if extra_ca_urls is None:
    extra_ca_urls = env.node.tag("punchkicker-trust-ca-urls")

if extra_ca_urls is not None:
    extra_ca_urls = extra_ca_urls.split(";")

    print()

    env.mkdir_p(localpath)

    with open(certconf, "r") as f:
        conflines = f.readlines()

    add_lines = []

    for ca_url in extra_ca_urls:
        url = urlparse(ca_url)
        filename = basename(url.path)
        print("    Fetching certificate %s:" % filename)
        dest = os.path.join(localpath, filename)
        env.download_url(ca_url, dest)
        entry = os.path.join(localdir, filename) + "\n"
        if entry not in conflines:
            add_lines.append(entry)
        print("        OK")

    if add_lines:
        # Replace comments and rewrite
        conflines = [l for l in conflines if not l.startswith("#")]
        new_comments = [
            "# Automatically generated by Punch Kicker Bootstrap\n",
            "# " +  ctime() + "\n",
            "# Do not edit.\n",
        ]

        conflines = new_comments + conflines + ["# Custom Local CAs\n"] + add_lines

        os.rename(certconf, certconf + ".bak")

        with open(certconf, "w") as f:
            f.writelines(conflines)

print("\n    Updating CA Certificates directories")
env.run_with_print(["/usr/sbin/update-ca-certificates"])
